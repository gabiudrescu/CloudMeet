name: Sync and Deploy

on:
  workflow_dispatch:
    inputs:
      token:
        description: 'GitHub token with workflows permission (only needed if sync fails)'
        required: false

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      changes: ${{ steps.sync.outputs.changes }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ inputs.token || github.token }}
          fetch-depth: 0

      - name: Sync with upstream
        id: sync
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Add upstream remote
          git remote add upstream https://github.com/dennisklappe/CloudMeet.git || true
          git fetch upstream

          # Check if there are changes
          if git diff --quiet HEAD upstream/main; then
            echo "No changes to sync"
            echo "changes=false" >> $GITHUB_OUTPUT
          else
            echo "changes=true" >> $GITHUB_OUTPUT

            # Merge upstream changes
            git merge upstream/main --allow-unrelated-histories -m "Sync with upstream CloudMeet" || {
              echo "Merge conflict detected. Attempting to resolve by keeping upstream changes for workflow files..."
              git checkout --theirs .github/workflows/*.yml || true
              git add .github/workflows/*.yml || true
              git commit -m "Sync with upstream CloudMeet" || true
            }

            git push
          fi

  deploy:
    needs: sync
    runs-on: ubuntu-latest
    permissions:
      contents: read
      deployments: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup Cloudflare resources
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          # Create D1 database if it doesn't exist
          echo "Checking D1 databases..."
          npx wrangler d1 list

          if ! npx wrangler d1 list 2>/dev/null | grep -q "cloudmeet-db"; then
            echo "Creating D1 database..."
            npx wrangler d1 create cloudmeet-db
          fi

          # Get database ID
          echo "Getting D1 database ID..."
          DB_ID=$(npx wrangler d1 list --json | jq -r '.[] | select(.name=="cloudmeet-db") | .uuid')
          echo "D1 database ID: $DB_ID"

          if [ -n "$DB_ID" ] && [ "$DB_ID" != "null" ]; then
            sed -i "s/database_id = \"YOUR_DATABASE_ID\"/database_id = \"$DB_ID\"/" wrangler.toml
            echo "DB_ID=$DB_ID" >> $GITHUB_ENV
          else
            echo "ERROR: Could not get D1 database ID"
            exit 1
          fi

          # Create KV namespace if it doesn't exist (ignore error if exists)
          echo "Creating KV namespace..."
          npx wrangler kv namespace create cloudmeet-kv || true

          # Get KV namespace ID from the list output
          echo "Getting KV namespace ID..."
          KV_LIST=$(npx wrangler kv namespace list)
          echo "$KV_LIST"
          # Extract ID for namespace titled "cloudmeet-kv"
          KV_ID=$(echo "$KV_LIST" | grep -E '"title": "cloudmeet-kv"' -B1 | grep '"id"' | head -1 | sed 's/.*"id": "\([^"]*\)".*/\1/')
          echo "KV namespace ID: $KV_ID"

          if [ -n "$KV_ID" ] && [ "$KV_ID" != "null" ]; then
            sed -i "s/id = \"YOUR_KV_NAMESPACE_ID\"/id = \"$KV_ID\"/" wrangler.toml
            echo "KV_ID=$KV_ID" >> $GITHUB_ENV
          else
            echo "ERROR: Could not get KV namespace ID"
            exit 1
          fi

          # Show final wrangler.toml
          echo "Final wrangler.toml:"
          cat wrangler.toml

          # Initialize database schema (ignore errors if tables exist)
          echo "Initializing database schema..."
          npx wrangler d1 execute cloudmeet-db --file=./schema.sql --remote || true

          # Run migrations
          echo "Running migrations..."
          for migration in migrations/*.sql; do
            if [ -f "$migration" ]; then
              echo "Running migration: $migration"
              npx wrangler d1 execute cloudmeet-db --file="$migration" --remote || true
            fi
          done

      - name: Build
        run: npm run build

      - name: Create Pages project if needed
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          if ! npx wrangler pages project list 2>/dev/null | grep -q "cloudmeet"; then
            echo "Creating Pages project..."
            npx wrangler pages project create cloudmeet --production-branch=main || true
          fi

          # Clear any existing env vars to avoid conflicts with wrangler.toml
          echo "Clearing existing env vars..."
          curl -X PATCH "https://api.cloudflare.com/client/v4/accounts/$CLOUDFLARE_ACCOUNT_ID/pages/projects/cloudmeet" \
            -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" \
            -H "Content-Type: application/json" \
            --data '{"deployment_configs": {"production": {"env_vars": null}}}' || true

      - name: Deploy to Cloudflare Pages
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          ADMIN_EMAIL: ${{ secrets.ADMIN_EMAIL }}
          APP_URL: ${{ secrets.APP_URL }}
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          EMAILIT_API_KEY: ${{ secrets.EMAILIT_API_KEY }}
          EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
          MICROSOFT_CLIENT_ID: ${{ secrets.MICROSOFT_CLIENT_ID }}
          MICROSOFT_CLIENT_SECRET: ${{ secrets.MICROSOFT_CLIENT_SECRET }}
        run: |
          # Add env vars to wrangler.toml before deploy
          cat >> wrangler.toml << EOF

          [vars]
          ADMIN_EMAIL = "$ADMIN_EMAIL"
          APP_URL = "$APP_URL"
          GOOGLE_CLIENT_ID = "$GOOGLE_CLIENT_ID"
          GOOGLE_CLIENT_SECRET = "$GOOGLE_CLIENT_SECRET"
          JWT_SECRET = "$JWT_SECRET"
          EMAILIT_API_KEY = "$EMAILIT_API_KEY"
          EMAIL_FROM = "$EMAIL_FROM"
          CRON_SECRET = "$CRON_SECRET"
          MICROSOFT_CLIENT_ID = "$MICROSOFT_CLIENT_ID"
          MICROSOFT_CLIENT_SECRET = "$MICROSOFT_CLIENT_SECRET"
          EOF

          echo "Final wrangler.toml:"
          cat wrangler.toml
          npx wrangler pages deploy .svelte-kit/cloudflare --project-name=cloudmeet --commit-dirty=true
